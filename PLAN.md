# План решения конфликта плагинов weight_scale и usb_serial

## Проблема

Плагин `weight_scale` конфликтует с плагином `usb_serial` (используемым для сканера штрих-кодов). Конфликт возникает из-за того, что `weight_scale` при поиске весов пытается подключиться ко *всем* обнаруженным USB-устройствам, включая уже используемый сканер штрих-кодов. Это приводит к ошибке `PlatformException(CONNECTION_FAILED, Failed to connect, Expected 0x0 byte, but get 0xec [init #1], null)` и нарушает работу сканера.

## Согласованное Решение

Изменить логику обнаружения устройств в плагине `weight_scale`, чтобы он был более избирательным и проверял только те устройства, которые потенциально являются весами, на основе их Vendor ID (VID) и Product ID (PID).

## Шаги Реализации

1.  **Определить список известных весов:** В классе `WeightScaleManager` (`lib/weight_scale_manager.dart`) создать статическую константу `_knownScaleIDs` со списком поддерживаемых моделей весов.
    ```dart
    // Список известных VID/PID весов
    static const List<Map<String, String>> _knownScaleIDs = [
      {
        'vendorID': '0x1a86',
        'productID': '0x7523',
        'name': 'Aclas',
      },
      // Сюда можно добавить другие модели весов
    ];
    ```
2.  **Изменить `_filterValidDevices`:** Обновить логику цикла в этом методе. Перед вызовом `_checkDevice` добавить проверку: соответствует ли VID/PID текущего устройства записям в `_knownScaleIDs`.
3.  **Вызывать `_checkDevice` только для известных весов:** Метод `_checkDevice` будет вызываться только для устройств, прошедших проверку VID/PID. Это предотвратит попытки подключения к сканеру штрих-кодов и другим нерелевантным USB-устройствам.
4.  **(Опционально) Улучшить `_checkDevice`:** Добавить обработку ошибок внутри `_checkDevice` и более надежное управление состоянием подключения/отключения во время проверки.

## Диаграмма Процесса (Mermaid)

```mermaid
graph TD
    A[getDevices] --> B(Получить список всех USB устройств);
    B --> C{Пройти по каждому устройству};
    C --> D{VID/PID устройства есть в _knownScaleIDs?};
    D -- Да --> E(Вызвать _checkDevice);
    D -- Нет --> F(Пропустить устройство);
    F --> C;
    E --> G{_checkDevice: Попытка connect};
    G -- Успешно --> H{_checkDevice: Ждать данные (500мс)};
    G -- Ошибка --> I(Завершить _checkDevice: false);
    H -- Данные получены --> J(Завершить _checkDevice: true);
    H -- Таймаут --> K(Завершить _checkDevice: false);
    J --> L[Добавить устройство в список валидных];
    I --> M{_checkDevice: Попытка disconnect (если нужно)};
    K --> M;
    L --> M;
    M --> C;
    C -- Список закончился --> N(Вернуть список валидных устройств);
```

## Следующий Шаг

Переключиться в режим "Code" для внесения изменений в файл `lib/weight_scale_manager.dart` согласно этому плану.