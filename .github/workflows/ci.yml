name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.32.8"

jobs:
  # ğŸ” Static Analysis & Formatting
  analysis:
    name: ğŸ“Š Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ¨ Check formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ” Run analyzer
        run: flutter analyze --fatal-infos

      - name: ğŸ“‹ Check pub publish
        run: dart pub publish --dry-run

  # ğŸ§ª Unit Tests
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: analysis

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ§ª Run unit tests
        run: flutter test --coverage --reporter expanded

      - name: ğŸ“Š Upload coverage to Codecov
        if: env.CODECOV_TOKEN
        uses: codecov/codecov-action@v4
        with:
          file: coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ğŸ—ï¸ Build Example App
  build:
    name: ğŸ—ï¸ Build Example
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test

    strategy:
      matrix:
        include:
          - platform: android
            build-cmd: flutter build apk --debug
            artifact-path: example/build/app/outputs/flutter-apk/app-debug.apk

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ“¦ Get example dependencies
        working-directory: example
        run: flutter pub get

      - name: ğŸ—ï¸ Build ${{ matrix.platform }}
        working-directory: example
        run: ${{ matrix.build-cmd }}

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: ${{ matrix.artifact-path }}
          retention-days: 7

  # ğŸ”— Integration Tests
  integration_test:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: analysis

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ“¦ Get example dependencies
        working-directory: example
        run: flutter pub get

      - name: ğŸ”— Run integration tests
        working-directory: example
        run: |
          flutter test integration_test/ --device-id emulator || true
          echo "Integration tests completed (may fail without physical device)"

  # ğŸ† Success Check
  ci_success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [analysis, test, build]
    if: always()

    steps:
      - name: âœ… Check all jobs
        run: |
          if [ "${{ needs.analysis.result }}" != "success" ] || 
             [ "${{ needs.test.result }}" != "success" ] || 
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ One or more jobs failed"
            exit 1
          else
            echo "âœ… All jobs passed successfully!"
          fi
